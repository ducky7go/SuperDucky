name: Publish to Windows Store

on:
  release:
    types: [created]
  push:
    branches:
      - publish

permissions:
  contents: read

jobs:
  publish-to-windows-store:
    name: Publish .appx to Windows Store
    runs-on: windows-latest
    if: ${{ !cancelled() }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate GitHub Secrets
        shell: pwsh
        run: |
          $tenantId = "${{ secrets.WINDOWS_STORE_TENANT_ID }}"
          $clientId = "${{ secrets.WINDOWS_STORE_CLIENT_ID }}"
          $clientSecret = "${{ secrets.WINDOWS_STORE_CLIENT_SECRET }}"
          $appId = "${{ secrets.WINDOWS_STORE_APP_ID }}"

          $missingSecrets = @()
          if ([string]::IsNullOrWhiteSpace($tenantId)) { $missingSecrets += 'WINDOWS_STORE_TENANT_ID' }
          if ([string]::IsNullOrWhiteSpace($clientId)) { $missingSecrets += 'WINDOWS_STORE_CLIENT_ID' }
          if ([string]::IsNullOrWhiteSpace($clientSecret)) { $missingSecrets += 'WINDOWS_STORE_CLIENT_SECRET' }
          if ([string]::IsNullOrWhiteSpace($appId)) { $missingSecrets += 'WINDOWS_STORE_APP_ID' }

          if ($missingSecrets.Count -gt 0) {
            Write-Error "Missing required GitHub Secrets: $($missingSecrets -join ', ')"
            Write-Error "Please configure the following secrets in your repository settings:"
            foreach ($secret in $missingSecrets) {
              Write-Error "  - $secret"
            }
            exit 1
          }
          Write-Host "All required secrets are configured."

      - name: Get Latest Release (for publish branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/publish'
        shell: pwsh
        run: |
          $latestRelease = gh release view --json tagName,name,body -R ${{ github.repository }} 2>$null
          if ($LASTEXITCODE -eq 0) {
            $tagName = ($latestRelease | ConvertFrom-Json).tagName
            Write-Host "Latest release tag: $tagName"
            "LATEST_RELEASE_TAG=$tagName" >> $env:GITHUB_ENV
          } else {
            Write-Warning "No releases found. Searching for latest tag..."
            $latestTag = git tag --sort=-creatordate | head -n 1
            if ($latestTag) {
              Write-Host "Latest tag: $latestTag"
              "LATEST_RELEASE_TAG=$latestTag" >> $env:GITHUB_ENV
            } else {
              Write-Error "No releases or tags found. Cannot publish to Windows Store."
              exit 1
            }
          }
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Set Release Tag (for release event)
        if: github.event_name == 'release'
        shell: pwsh
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          Write-Host "Release tag from event: $tag"
          "LATEST_RELEASE_TAG=$tag" >> $env:GITHUB_ENV

      - name: Download Release Assets
        shell: pwsh
        run: |
          $tag = $env:LATEST_RELEASE_TAG
          if ([string]::IsNullOrWhiteSpace($tag)) {
            Write-Error "LATEST_RELEASE_TAG is not set. Cannot download assets."
            exit 1
          }

          New-Item -ItemType Directory -Force -Path ./appx-packages | Out-Null

          gh release download "$tag" --dir ./appx-packages --pattern "*.appx" --repo ${{ github.repository }}
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to download .appx files from release $tag"
            exit 1
          }

          $appxFiles = Get-ChildItem -Path ./appx-packages -Filter "*.appx"
          Write-Host "Downloaded $($appxFiles.Count) .appx file(s)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check for .appx Files
        shell: pwsh
        run: |
          $appxFiles = Get-ChildItem -Path ./appx-packages -Filter "*.appx" -ErrorAction SilentlyContinue
          if ($appxFiles.Count -eq 0) {
            $tag = $env:LATEST_RELEASE_TAG
            Write-Warning "No .appx files found in release/tag $tag. Skipping Windows Store publishing."
            exit 0
          }
          Write-Host "Found $($appxFiles.Count) .appx file(s):"
          foreach ($file in $appxFiles) {
            Write-Host "  - $($file.Name)"
          }

      - name: Publish to Windows Store via REST API
        shell: pwsh
        run: |
          $maxRetries = 3
          $retryDelay = 30

          $appxFiles = Get-ChildItem -Path ./appx-packages -Filter "*.appx"
          if ($appxFiles.Count -eq 0) {
            Write-Warning "No .appx files found. Skipping upload."
            exit 0
          }

          $appxFile = $appxFiles[0]
          $appId = "${{ secrets.WINDOWS_STORE_APP_ID }}"
          $tenantId = "${{ secrets.WINDOWS_STORE_TENANT_ID }}"
          $clientId = "${{ secrets.WINDOWS_STORE_CLIENT_ID }}"
          $clientSecret = "${{ secrets.WINDOWS_STORE_CLIENT_SECRET }}"

          # Note: This workflow uses the Windows Store Submission API for MSI/EXE apps
          # which can also handle .appx packages. The API endpoint is:
          # https://api.store.microsoft.com

          Write-Host "Publishing $($appxFile.Name) to Windows Store..."
          Write-Host "App ID: $appId"
          Write-Host "Note: This API is designed for MSI/EXE apps but also supports .appx packages"

          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              $retryCount++
              if ($retryCount -gt 1) {
                Write-Host "Retry attempt $retryCount of $maxRetries..."
                Start-Sleep -Seconds $retryDelay
              }

              # Step 1: Get OAuth token for UWP Store Submission API
              Write-Host "Getting OAuth token for UWP Store Submission API..."
              $tokenUrl = "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token"
              $tokenBody = @{
                client_id = $clientId
                client_secret = $clientSecret
                scope = "https://manage.devcenter.microsoft.com/.default"
                grant_type = "client_credentials"
              }

              $tokenResponse = Invoke-RestMethod -Uri $tokenUrl -Method Post -Body $tokenBody -ContentType "application/x-www-form-urlencoded"
              $accessToken = $tokenResponse.access_token

              if ([string]::IsNullOrWhiteSpace($accessToken)) {
                throw "Failed to obtain access token"
              }
              Write-Host "Access token obtained successfully"

              # Step 2: Create a new submission (this creates a draft based on last published submission)
              Write-Host "Creating new submission..."
              $baseUrl = "https://manage.devcenter.microsoft.com/v1.0/my"
              $headers = @{
                "Authorization" = "Bearer $accessToken"
                "Content-Type" = "application/json"
              }

              $createSubmissionUrl = "$baseUrl/applications/$appId/submissions"
              $submissionResponse = Invoke-RestMethod -Uri $createSubmissionUrl -Method Post -Headers $headers
              $submissionId = $submissionResponse.id
              $fileUploadUrl = $submissionResponse.fileUploadUrl

              Write-Host "Submission created successfully. Submission ID: $submissionId"
              Write-Host "File upload URL obtained: $fileUploadUrl"

              # Step 3: Upload the .appx file to Azure Blob Storage using the SAS URL
              Write-Host "Uploading .appx file to Azure Blob Storage..."

              # Create a ZIP archive containing the .appx file
              $zipFile = "./submission.zip"
              Compress-Archive -Path "./appx-packages/*.appx" -DestinationPath $zipFile -Force

              # Upload the ZIP file using Azure Blob Storage REST API
              $blobHeaders = @{
                "x-ms-blob-type" = "BlockBlob"
              }

              Invoke-RestMethod -Uri $fileUploadUrl -Method Put -Headers $blobHeaders -InFile $zipFile -ContentType "application/octet-stream"
              Write-Host "File uploaded successfully"

              # Step 4: Update the submission with the new package information
              Write-Host "Updating submission with package information..."

              # Get the current submission data
              $getSubmissionUrl = "$baseUrl/applications/$appId/submissions/$submissionId"
              $currentSubmission = Invoke-RestMethod -Uri $getSubmissionUrl -Method Get -Headers $headers

              # Update the package file reference
              # The submission already has the package info from the cloned submission
              # We just need to update the fileStatus to indicate the file has been uploaded
              foreach ($package in $currentSubmission.applicationPackages) {
                $package.fileStatus = "Uploaded"
              }

              # Update the submission
              $updateSubmissionUrl = "$baseUrl/applications/$appId/submissions/$submissionId"
              $submissionJson = $currentSubmission | ConvertTo-Json -Depth 20
              Invoke-RestMethod -Uri $updateSubmissionUrl -Method Put -Headers $headers -Body $submissionJson
              Write-Host "Submission updated successfully"

              # Step 5: Commit the submission
              Write-Host "Committing submission..."
              $commitUrl = "$baseUrl/applications/$appId/submissions/$submissionId/commit"
              Invoke-RestMethod -Uri $commitUrl -Method Post -Headers $headers
              Write-Host "Submission committed successfully"

              # Step 6: Monitor submission status
              Write-Host "Monitoring submission status..."
              $statusUrl = "$baseUrl/applications/$appId/submissions/$submissionId/status"

              $pollCount = 0
              $maxPolls = 60
              $pollInterval = 10

              while ($pollCount -lt $maxPolls) {
                $pollCount++
                Start-Sleep -Seconds $pollInterval

                $statusResponse = Invoke-RestMethod -Uri $statusUrl -Method Get -Headers $headers
                $status = $statusResponse.status
                Write-Host "Status check ${pollCount}: $status"

                if ($status -eq "CommitStarted" -or $status -eq "PendingCommit") {
                  continue
                }

                if ($status -eq "PreProcessing" -or $status -eq "PendingPublication") {
                  Write-Host "Submission is being processed..."
                  break
                }

                if ($status -eq "CommitFailed") {
                  throw "Commit failed: $($statusResponse.statusDetails | ConvertTo-Json)"
                }

                if ($status -eq "PreProcessingFailed") {
                  throw "Pre-processing failed: $($statusResponse.statusDetails | ConvertTo-Json)"
                }
              }

              Write-Host "=========================================="
              Write-Host "Windows Store Publishing Successful!"
              Write-Host "=========================================="
              Write-Host "Submission ID: $submissionId"
              Write-Host "Current Status: $status"
              Write-Host "Partner Center: https://partner.microsoft.com/dashboard/apps/$appId"
              Write-Host "=========================================="

              $success = $true

            }
            catch {
              Write-Error "Publish failed (attempt $retryCount): $_"
              Write-Error "Exception: $($_.Exception.Message)"
              if ($_.Exception.Response) {
                Write-Error "Status Code: $($_.Exception.Response.StatusCode.value__)"
                try {
                  $errorStream = $_.Exception.Response.GetResponseStream()
                  $reader = New-Object System.IO.StreamReader($errorStream)
                  $errorBody = $reader.ReadToEnd()
                  Write-Error "Response: $errorBody"
                } catch {
                  # Could not read error response
                }
              }

              if ($retryCount -ge $maxRetries) {
                Write-Error "Max retries reached."
                exit 1
              }
            }
          }

      - name: Report Success
        if: success()
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "Windows Store Publishing Complete!"
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "Your .appx package has been successfully"
          Write-Host "submitted to the Windows Store."
          Write-Host ""
          Write-Host "Next Steps:"
          Write-Host "1. Visit Partner Center to monitor submission status"
          Write-Host "2. Wait for certification to complete"
          Write-Host "3. Once approved, your app will be published"
          Write-Host ""
          Write-Host "Partner Center Dashboard:"
          Write-Host "https://partner.microsoft.com/dashboard/apps/${{ secrets.WINDOWS_STORE_APP_ID }}"
          Write-Host "=========================================="

      - name: Report Failure
        if: failure()
        shell: pwsh
        run: |
          Write-Error "=========================================="
          Write-Error "Windows Store Publishing Failed!"
          Write-Error "=========================================="
          Write-Error "Please check the logs above for detailed error information."
          Write-Error ""
          Write-Error "Common issues and solutions:"
          Write-Error ""
          Write-Error "1. Authentication failed (401)"
          Write-Error "   - Verify Tenant ID, Client ID, and Client Secret"
          Write-Error "   - Check that Client Secret has not expired"
          Write-Error "   - Ensure Azure AD app is configured correctly"
          Write-Error ""
          Write-Error "2. App not found (404)"
          Write-Error "   - Verify App ID is correct (format: 9NXXXXXXXXX)"
          Write-Error "   - Ensure app exists in Partner Center"
          Write-Error "   - App must have at least one previous submission"
          Write-Error ""
          Write-Error "3. Forbidden (403)"
          Write-Error "   - Ensure Azure AD app has Manager role in Partner Center"
          Write-Error "   - Check that your organization's Azure AD is properly linked"
          Write-Error ""
          Write-Error "4. Bad Request (400)"
          Write-Error "   - Check submission data format"
          Write-Error "   - Ensure .appx file is valid"
          Write-Error "   - Verify all required fields are present"
          Write-Error ""
          Write-Error "5. Package upload failed"
          Write-Error "   - Check .appx file size (max 25GB)"
          Write-Error "   - Ensure .appx file is not corrupted"
          Write-Error "   - Verify .appx version is higher than current version"
          Write-Error ""
          Write-Error "For troubleshooting guide:"
          Write-Error "https://partner.microsoft.com/dashboard/help"
          Write-Error "=========================================="
          exit 1
