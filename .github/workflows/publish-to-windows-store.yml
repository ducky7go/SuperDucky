name: Publish to Windows Store

on:
  release:
    types: [created]
  push:
    branches:
      - publish

permissions:
  contents: read

jobs:
  publish-to-windows-store:
    name: Publish .appx to Windows Store
    runs-on: windows-latest
    # Skip if no .appx files in the release
    if: ${{ !cancelled() }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Validate GitHub Secrets
        shell: pwsh
        run: |
          $tenantId = "${{ secrets.WINDOWS_STORE_TENANT_ID }}"
          $clientId = "${{ secrets.WINDOWS_STORE_CLIENT_ID }}"
          $clientSecret = "${{ secrets.WINDOWS_STORE_CLIENT_SECRET }}"
          $sellerId = "${{ secrets.WINDOWS_STORE_SELLER_ID }}"
          $appId = "${{ secrets.WINDOWS_STORE_APP_ID }}"

          $missingSecrets = @()
          if ([string]::IsNullOrWhiteSpace($tenantId)) { $missingSecrets += 'WINDOWS_STORE_TENANT_ID' }
          if ([string]::IsNullOrWhiteSpace($clientId)) { $missingSecrets += 'WINDOWS_STORE_CLIENT_ID' }
          if ([string]::IsNullOrWhiteSpace($clientSecret)) { $missingSecrets += 'WINDOWS_STORE_CLIENT_SECRET' }
          if ([string]::IsNullOrWhiteSpace($sellerId)) { $missingSecrets += 'WINDOWS_STORE_SELLER_ID' }
          if ([string]::IsNullOrWhiteSpace($appId)) { $missingSecrets += 'WINDOWS_STORE_APP_ID' }

          if ($missingSecrets.Count -gt 0) {
            Write-Error "Missing required GitHub Secrets: $($missingSecrets -join ', ')"
            Write-Error "Please configure the following secrets in your repository settings:"
            foreach ($secret in $missingSecrets) {
              Write-Error "  - $secret"
            }
            exit 1
          }

          Write-Host "All required secrets are configured."

      - name: Get Latest Release (for publish branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/publish'
        shell: pwsh
        run: |
          # Get the latest published (non-draft) release using GitHub CLI
          $latestRelease = gh release view --json tagName,name,body -R ${{ github.repository }} 2>$null
          if ($LASTEXITCODE -eq 0) {
            $tagName = ($latestRelease | ConvertFrom-Json).tagName
            Write-Host "Latest release tag: $tagName"
            "LATEST_RELEASE_TAG=$tagName" >> $env:GITHUB_ENV
          } else {
            Write-Warning "No releases found. Searching for latest tag..."
            # Fallback to getting the latest tag by creation date
            $latestTag = git tag --sort=-creatordate | head -n 1
            if ($latestTag) {
              Write-Host "Latest tag: $latestTag"
              "LATEST_RELEASE_TAG=$latestTag" >> $env:GITHUB_ENV
            } else {
              Write-Error "No releases or tags found. Cannot publish to Windows Store."
              exit 1
            }
          }
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Set Release Tag (for release event)
        if: github.event_name == 'release'
        shell: pwsh
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          Write-Host "Release tag from event: $tag"
          "LATEST_RELEASE_TAG=$tag" >> $env:GITHUB_ENV

      - name: Download Release Assets
        shell: pwsh
        run: |
          $tag = $env:LATEST_RELEASE_TAG
          if ([string]::IsNullOrWhiteSpace($tag)) {
            Write-Error "LATEST_RELEASE_TAG is not set. Cannot download assets."
            exit 1
          }

          New-Item -ItemType Directory -Force -Path ./appx-packages | Out-Null

          # Download release assets using GitHub CLI
          gh release download "$tag" --dir ./appx-packages --pattern "*.appx" --repo ${{ github.repository }}
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to download .appx files from release $tag"
            exit 1
          }

          $appxFiles = Get-ChildItem -Path ./appx-packages -Filter "*.appx"
          Write-Host "Downloaded $($appxFiles.Count) .appx file(s)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check for .appx Files
        shell: pwsh
        run: |
          $appxFiles = Get-ChildItem -Path ./appx-packages -Filter "*.appx" -ErrorAction SilentlyContinue
          if ($appxFiles.Count -eq 0) {
            $tag = $env:LATEST_RELEASE_TAG
            Write-Warning "No .appx files found in release/tag $tag. Skipping Windows Store publishing."
            exit 0
          }
          Write-Host "Found $($appxFiles.Count) .appx file(s):"
          foreach ($file in $appxFiles) {
            Write-Host "  - $($file.Name)"
          }

      - name: Install .NET 8 Desktop Runtime
        shell: pwsh
        run: |
          # Install .NET 8 Desktop Runtime (required for msstore CLI)
          winget install Microsoft.DotNet.DesktopRuntime.8 --accept-source-agreements --accept-package-agreements

      - name: Install Microsoft Store Developer CLI
        shell: pwsh
        run: |
          # Install msstore CLI using winget
          winget install "Microsoft Store Developer CLI" --accept-source-agreements --accept-package-agreements

      - name: Configure and Publish to Windows Store
        shell: pwsh
        run: |
          $maxRetries = 3
          $retryDelay = 30

          $appxFiles = Get-ChildItem -Path ./appx-packages -Filter "*.appx"
          if ($appxFiles.Count -eq 0) {
            Write-Warning "No .appx files found. Skipping upload."
            exit 0
          }

          # Use the first .appx file (assuming one package per release)
          $appxFile = $appxFiles[0]
          $appId = "${{ secrets.WINDOWS_STORE_APP_ID }}"
          Write-Host "Publishing $($appxFile.Name) to Windows Store..."
          Write-Host "App ID: $appId"

          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              $retryCount++

              if ($retryCount -gt 1) {
                Write-Host "Retry attempt $retryCount of $maxRetries..."
                Start-Sleep -Seconds $retryDelay
              }

              # Configure msstore CLI with credentials from secrets
              Write-Host "Configuring Microsoft Store Developer CLI..."
              msstore reconfigure `
                --tenantId "${{ secrets.WINDOWS_STORE_TENANT_ID }}" `
                --sellerId "${{ secrets.WINDOWS_STORE_SELLER_ID }}" `
                --clientId "${{ secrets.WINDOWS_STORE_CLIENT_ID }}" `
                --clientSecret "${{ secrets.WINDOWS_STORE_CLIENT_SECRET }}" `
                2>&1 | Write-Host

              # Check if configuration was successful
              if ($LASTEXITCODE -ne 0) {
                throw "msstore reconfigure failed with exit code $LASTEXITCODE"
              }

              # Publish using msstore CLI with the .appx file
              Write-Host "Starting publish operation..."
              $output = msstore publish "." `
                --inputDirectory "./appx-packages" `
                --appId "$appId" `
                2>&1
              Write-Host $output

              if ($LASTEXITCODE -eq 0) {
                Write-Host "Successfully published $($appxFile.Name) to Windows Store"
                Write-Host "App ID: $appId"
                Write-Host "Store Dashboard: https://partner.microsoft.com/dashboard/apps/$appId"
                $success = $true
              } else {
                throw "msstore publish failed with exit code $LASTEXITCODE"
              }
            }
            catch {
              Write-Error "Publish failed (attempt $retryCount): $_"
              if ($retryCount -ge $maxRetries) {
                Write-Error "Max retries reached. Publish failed for $($appxFile.Name)"
                exit 1
              }
            }
          }

      - name: Report Success
        if: success()
        shell: pwsh
        run: |
          $triggerType = "${{ github.event_name }}"
          $releaseInfo = $env:LATEST_RELEASE_TAG

          Write-Host "=========================================="
          Write-Host "Windows Store Publishing Successful!"
          Write-Host "=========================================="
          if ($triggerType -eq "release") {
            Write-Host "Triggered by: Release creation"
          } else {
            Write-Host "Triggered by: Push to publish branch"
          }
          Write-Host "Release/Tag: $releaseInfo"
          Write-Host "App ID: ${{ secrets.WINDOWS_STORE_APP_ID }}"
          Write-Host "Store Dashboard: https://partner.microsoft.com/dashboard/apps/${{ secrets.WINDOWS_STORE_APP_ID }}"
          Write-Host "=========================================="

      - name: Report Failure
        if: failure()
        shell: pwsh
        run: |
          $triggerType = "${{ github.event_name }}"
          $releaseInfo = $env:LATEST_RELEASE_TAG

          Write-Error "=========================================="
          Write-Error "Windows Store Publishing Failed!"
          Write-Error "=========================================="
          if ($triggerType -eq "release") {
            Write-Error "Triggered by: Release creation"
          } else {
            Write-Error "Triggered by: Push to publish branch"
          }
          Write-Error "Release/Tag: $releaseInfo"
          Write-Error "Please check the logs above for detailed error information."
          Write-Error ""
          Write-Error "Common issues:"
          Write-Error "1. Seller ID must be a pure number (e.g., 123456789), not a UUID"
          Write-Error "2. App ID must be in format 9NXXXXXXXXX (e.g., 9NDTBDKQBX30)"
          Write-Error "3. Verify all credentials in GitHub Secrets are correct"
          Write-Error "=========================================="
          exit 1
